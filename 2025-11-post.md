---
title: 'Evaluating AI-based molecular modelling with Physical Simulation'
author: Hao Lan
date: 2025-10-26
permalink: /posts/2025-11-XX/
tags:
  - Statictical Mechanics (Force Field) and Quantum Mechanics (DFT)
  - Atomic Neural Network Potentials
  - Enhanced Molecular Dynamics
---

## Introduction
<p style="text-align: justify;">
In my last blog post, I tested AI co-folding model for novel chemical modalities including macrocyclic molecular glue and its induced protein complexes. There are some postive feedback but no much detailed investigation was performed. As a computational chemist and cheminformation, I found it would be interesting to study and analyse these models with physics in terms of sampling effiency and energy accuracy, which could inspire some practical applications for drug discovery industry. In this new article, I would like to make some complementarity and particularly focus on two questions:

1. Which are those 'good' AI models approaching physics and also with low computational cost?

2. Can physics help to identify, refine or even rescure those 'imperfect' AI models?   
</p>

## Key Conclusions at the Begining

a. Some latest machine learning force fields (MMFFs) based on atomic neural network potentials (NNPs) reach quantum mechanics (QM) accurary for organic small molecules. They could be used as DFT surragate for energy calculation quickly, despite their speed for simulation still largely inferior to those traditional force fields with classic parameters. Moreover, the fundamental architecture of NNPs may further restrict their usage in coupled with enhanced sampling techniques such as Hamiliton replica exchange MD or metadynamics.

b. Traditional statistical mechanics could deal with most challenging chemcial systems, but there are some tricky situations (e.g., Atropisomerism) which require extra cautions. If such scenario was wrongly generated by AI, it would be even more hard for physical modelling to rescure.

c. Some mature machine learning models for predicting atomic properties in cheminformatics show benefits on computational chemistry (though in subconscious way), some of which have accelerated simulation workflow efficiently and made previously impossible parameterisation to be feasible.

d. The AI co-folding model provided hypothesis in a quick and easy way (if ignore the cost of data and training), of which structures could be further evaluated by expensive physical approaches in order to identify and reduce false postive results.

## Ligand Conformational Analysis in Solution

For organic small molecule drugs, solution-state conformations play important roles on both receptor binding events and DMPK properties. Computational/medicinal chemists often apply strategies of conformation control to restrain or even lock bioactive state in solution for reducing entropic pentalty and enhancing binding affinity on certain target. For modalities beyond the rule of five (bRo5), their folding conformations (or so-called 'Chameleonicity') are also critical for desired permabilities and solubilities. Following my previous article, the macrocyclic MG Elironrasib (**Figure 1**) was studied again, for solution-state conformational analysis. Herein, the performance of several force fields including atomic NNPs was tested by their simulation speed for sampling and also energy accuaracy relative to QM/DFT reference.

![Figure 1a](images/figure1a.png) 
![Figure 1b](images/figure1b.png)
Figure 1. The 2D structure of Elironrasib and its bioactive conformation as precursor minimised from covalent ternary complex crystallography (PDB: 9BFX)
<img /><br>

### Choice of Sampling Approach

In molecular modelling, both Monte Carlo (MC) and Molecular Dynamics (MD) argorithms are commonly used for simulation. During my PhD couple of years ago, *MacroModel* was always my first choice to sample small-molecule conformational minima used for NMR structure elucidation. The software is based on Metropolis MC and was developed by Still group, acquired by Schrodinger later. Together with encrypted OPLSx force field originally from Jorgensen group, the method is very powerful to search multiple low-energy conformers in solution. Similarly for protein modelling, there are also softwares like Rosetta which I have used a lot since academia. However, the pure MC algorithm could only deal with the system with limited degrees of freedom (e.g., bond torsions) considering ease of convergence (so it is usually applied just on solute with implicit solvation model) and I have gradually realised the importance of explicit waters for CADD research during these years in industry. Therefore, molecular dynamics with explicit waters were preferentially chosen for conformational sampling in this study (**Figure 2**).

![Figure 2](images/figure2.png)
Figure 2. The mixture system for Elironrasib sovlated in water (TIP3P models) under cubic periodic boundary condition (PBC).
<img /><br>

There are several softwares and methods might be suitable for such computational modelling task, as suggested by some LLMs. With the open source spirit and also for this blog, I determinied to use *gromacs, openmm, openff, xtb, orca, pytorch* and other non-commerical modules (at least free for personal use) which I have gained the most experience with.

*Here are 4 common force fields used in this test:*

1. **General AMBER Force Field (GAFF)** - A conventional small-molecule force field compatible with well-known AMBER family (used in my PhD paper previously)
2. **SAGE (OpenFF-2.2.1)** - The latest generation of small-molecule force field released by Open Force Field Initiative (I think their benchmark report to outperform GAFF)
3. **ANI2x** - The atomic neural network potential (NNP) in pioneer ANI family developed by Roitberg group, supporting most uncharged organic elements
4. **MACE** - A series of new NNPs developed after ANI (herein only the distilled small model was used for simulation due to efficiency)

The biggest chanllenge in molecular dynamics is ergodicity under Newton's law. To prevent trapping in the local minimum and enhance sampling, I added the algorithm of replica exchange (REMD) over 300 K as well as solute tempering (REST) technique by modifying Hamiltonians. However, this trick can only be applied on classic force field with explicit terms of bonding and non-bonding parameters. In NNPs, the forward calculation of energies and gradient forces is labile based on the feature of atomic positions followed by neural network blackbox (**Text 3**), just like ETKDG biased with so-called 'distance constraints' from crystallography, so there is no analytical function to modulate easily in theory. The high temperatures may also raise the risk of thermal instability for the system under NNPs because most training data are QM/DFT geometries minimised with electronic and zero-point energies in vaccum.

```python
class HybridNNP(torch.nn.Module):
    def __init__(self, atomic_numbers, ml_atoms):
        super().__init__()
        self.indices = torch.tensor(ml_atoms, dtype=torch.long, device=device)
        self.atomic_numbers = torch.tensor(atomic_numbers, device=device).unsqueeze(0)
        self.model = ANI2x(periodic_table_index=True)
        self.model.to(self.atomic_numbers.device)
    def forward(self, positions):
        positions = positions.to(self.atomic_numbers.device)
        positions = positions[self.indices]
        positions = positions.unsqueeze(0).float() * 10 # nm -> Å
        result = self.model((self.atomic_numbers, positions))
        energy = result.energies[0] * 2625.5 # Hartree -> kJ/mol
        return energy
```
**Text 3.** A Pytorch code for the forward calculation of atomic NNPs (this example was commonly used in torchANI, openmm-ml and other tools). 

Since I did not compile the gromacs with plumed (module for advanced MD) in my PC with 16 cores and NVIDIA RTX5070 GPU, the REST simulation and metadynamics mentioned later was performed with openmm and corresponding tools. Honestly, there is no much difference in terms of simulation speed between two open platforms (though a bit slower than Desmond, a commerical software from D.E.Shaw and Schrodinger designed for industry) and we have modules like parmed and openff interchange to convert among different formats of topology. 

Nevertheless, one challenge is to integrate explicit water model (i.e., TIP3P herein) with organic solute under NNPs. Traditional, such modelling is usually processed by QM/MM better with electronic embedding on the boundary (as emphasized by Adrian during my PhD in Bristol). Considering the speed of computation and the charateristic of NNPs, ML/MM with mechanical embedding could be an alternative approach for this study (thanks to the tutorial from openmm workshops). For building ML/MM system, most classical parameters on the solute must be removed (**Text 4**) and replaced by NNPs (**Text 3**).

```python
def removeBonds(system, atoms, removeInSet=True, removeConstraints=True):

    atomSet = set(atoms)
    import xml.etree.ElementTree as ET
    xml = mm.XmlSerializer.serialize(system)
    root = ET.fromstring(xml)

    def shouldRemove(termAtoms):
        return all(a in atomSet for a in termAtoms) == removeInSet

    for bonds in root.findall("./Forces/Force/Bonds"):
        for bond in bonds.findall("Bond"):
            bondAtoms = [int(bond.attrib[p]) for p in ("p1", "p2")]
            if shouldRemove(bondAtoms):
                bonds.remove(bond)
    for angles in root.findall("./Forces/Force/Angles"):
        for angle in angles.findall("Angle"):
            angleAtoms = [int(angle.attrib[p]) for p in ("p1", "p2", "p3")]
            if shouldRemove(angleAtoms):
                angles.remove(angle)
    for torsions in root.findall("./Forces/Force/Torsions"):
        for torsion in torsions.findall("Torsion"):
            torsionAtoms = [int(torsion.attrib[p]) for p in ("p1", "p2", "p3", "p4")]
            if shouldRemove(torsionAtoms):
                torsions.remove(torsion)

    if removeConstraints:
        for constraints in root.findall("./Constraints"):
            for constraint in constraints.findall("Constraint"):
                constraintAtoms = [int(constraint.attrib[p]) for p in ("p1", "p2")]
                if shouldRemove(constraintAtoms):
                    constraints.remove(constraint)

    return mm.XmlSerializer.deserialize(ET.tostring(root, encoding="unicode"))


def removeMMInteraction(system, ml_atoms):
    newSystem = removeBonds(system, ml_atoms)
    for force in newSystem.getForces():
        if isinstance(force, mm.NonbondedForce):
            for i in range(len(ml_atoms)):
                for j in range(i):
                    force.addException(ml_atoms[i], ml_atoms[j], 0, 1, 0, True)
        elif isinstance(force, mm.CustomNonbondedForce):
            existing = set(tuple(force.getExclusionParticles(i)) for i in range(force.getNumExclusions()))
            for i in range(len(ml_atoms)):
                a1 = ml_atoms[i]
                for j in range(i):
                    a2 = ml_atoms[j]
                    if (a1, a2) not in existing and (a2, a1) not in existing:
                        force.addExclusion(a1, a2, True)
    return newSystem
```
**Text 4.** The functions to remove classic force field parameters on ligand for ML/MM simulation in OpenMM system.

After several trials in parameterisation and testing, I managed to get the performance of different simulations on Elironrasib as summarised below:

| Methods | Ensembles | Timescale | Stepsize | Constraints | Enhancement | Platform | Speed |
| :---: | :---: | :---:| :---: | :---: | :---: | :---: | :---: |
| GAFF | NPT 300 K | 10 ns | 2.0 fs/step | H-bond | None | OpenMM | 465 ns/day |
| SAGE | NPT 300 K | 10 ns | 2.0 fs/step | H-bond | None | OpenMM | 460 ns/day |
| ANI2x | NPT 300 K | 200 ps | 0.5 fs/step | None | None | OpenMM | 1.3 ns/day |
| MACE_small | NPT 300K | 100 ps | 0.5 fs/step | None | None | OpenMM | 0.72 ns/day |
| SAGE (REMD) | NPT with 16 replica 300-475 K | 10 ns | 2.0 fs/step | H-bond | 10000 MC exchange attempts | GROMACS | 35 ns/day/rep |
| SAGE (REST) | NPT with 16 replica 300-600 K | 10 ns | 2.0 fs/step | H-bond | 10000 MC exchange attempts | OpenMM | 21 ns/day/rep |

**Table 5.** All simulation approaches used for conformational sampling of Elironrasib in explicit solvents.  

It is obvious that the simulation speed with two NNPs is **much slower** than the other two classical force fields, while the latter methods spent more time on the initial parameterisation (i.e., compute BCC atomic charges with semi-empirical AM1 protocol) regarding Elironrasib has more than 150 atoms. Given the timescale especially for NNPs, these modelling were supposed to sample still limited geometries distinct from the minimised bioactive state (**Figure 1**) used as the initial structure. Neverthless, there are 2 core questions in my mind as computational chemist:

**Which of those simulations sample the most of low-energy conformers efficiently?**

**Any significant conformational change from the bioactive state during landscape exploration?**

For answering the first question, it is necessary to run QM-level energy minimisations as the higher standard to estimate these simulation qualities. To ensure the accuracy of sampling geometries, up to 1000 snapshots were extracted from each simulation, of which Elironrasib solute is optimised with semi-empirical XTB under implicit ALPB model. I believe such accuracy is sufficient before further single-point energy (SPE) calculation at DFT level (plus PCM model if necessary) based on my experience in QM calculations: **Geometry is less sensitive to basis set than energy, and even just XTB is often enough for optimisation.** 

Although the initial guess and iterations of self-consistent field (SCF) calculation in XTB is much faster than in DFT, I still need to set the convergence critira as crude as possible in order to finish thousands of ensemble optimisations in days on my PC. By testing on the example of Elironrasib's bioactive conformation, I think the error by quick minimisation is acceptable (**Figure 6**) and somehow we can sacrefice accuracy for efficiency when necessary (p.s. one of the most important lessons I have learnt in industry...)

![Figure 6](images/figure6.png)
| XTB opt. convergence criteria | aligned best rms Å |	relative XTB opt. energy (+ ALPB) kcal/mol | relative DFT SPE by looseSCF (+ CPCM) kcal/mol | relative DFT SPE by NormSCF (+ CPCM) kcal/mol |
| :---: | :---: | :---:| :---: | :---: |
| extreme | 0.000 | 0.000 | 0.087 | 0.000 |
| vtight | 0.042 | 0.003 | 0.124 | 0.038 |
| tight	| 0.791	| 0.471 | 1.647 | 1.561 |
| normal | 0.777 | 0.872 | 1.350 | 1.261 |
| lax | 1.077 | 2.039 | 2.123 | 2.036 |
| loose	| 1.230	| 2.673 | 1.818 | 1.734 |
| sloppy | 1.235 | 2.748 | 1.960 | 1.876 |
| *crude*	| *1.264* | *3.471* | *2.321* | *2.238* |
| ff_original | 1.310 | 35.625 | 20.528 | 20.456 |

**Figure 6.** The XTB geometry optimisations and DFT single point energy calculations on Elironrasib bioactive state extracted and minimied (MMFF) from protein co-crystallography (PDB: 9BFX). A sufficent accuracy was afforded by the quickest *crude* minimisation. 

For DFT SPE calculation on conformers, my favorate method is *wB97X(D3bj)/def2-TZVP* which is a range-separated hybrid functional with dispersion correction under triple-zeta basis set. I remember this was recommanded by Grimme group to calculate the mid-size system with signifcant non-covalent interactions (one of the drawback for B3LYP). Although no diffusion function (time-consuming!) was added in the basis set, such method used to reproduce NMR data accurately for my PROTACs folding in solutions (as one of my PhD projects almost 5 years ago). I am also glad to see similar DFT methods were later used by MACE and Meta FAIR Chemistry teams to generate various OMol data for training their NNPs. Due to my limited computational resource, the SCF convergence criteria in *orca* was set to loose (i.e., $\mathbf{1.0 \times 10^{-5}}$ a.u. change in both energy and rms) for getting each Elironrasib conformer's SPE fastly (around 20-30 mins). Although this might be a really low standard for *Gaussian* which set over $\mathbf{1.0 \times 10^{-7}}$ a.u., the loose SCF is same as the default quick setting in *Jaguar* from Schrodinger and it closely approach to normal SCF ($\mathbf{1.0 \times 10^{-6}}$ a.u.) by *orca* run in this study (**Figure 6**).      

### Efficiency on Elironrasib Conformational Sampling and Energy Estimation

According to the ECDF plot (**Figure 7**), most low-energy conformers of Elironrasib are sampled from the classic mechanics with enhanced simulation technique. The SAGE force field powered by replica exchange and solute tempering are able to afford to produce most stable geometries that can be recognised by XTB minimisation with implicit ALPB solvation.

![Figure 7](images/figure7.png)
**Figure 7**. The empirical cumulative distribution of conformational energies (XTB optimisation) by each samplling method. 

For feasible DFT SPE calculations, 10 lowest energy XTB conformers were extracted from each simulation approach and estimated by *wB97X(D3bj)/def2-TZVP*. There is clear correlation between the SOTA semi-empirical XTB and such QM energies under implicit solvation model (**Figure 8**).  

![Figure 8](images/figure8.png)
**Figure 8**. The clear correlation between XTB optimised energies and DFT SPE (*wB97X(D3bj)/def2-TZVP*).

Based on XTB optimised geometries, I then evaluated energies given by 4 larger NNP models (i.e., MACE and UMA) respectively trained from OMol23 and OMol25 QM dataset released recently. Because most models have not supported solvation yet, I have to exclude the CPCM correction in my DFT for the reasonable comparsion. To my surprise, these NNPs reach to the DFT accuracy incrediably (**Figure 9**) especially for UMA/OMol25 models and the SPE task finish just in seconds! Now I believe what annuouced by Meta FAIR Chemistry team: **MLFF could be a real DFT surrogate for computational chemistry.**

![Figure 9](images/figure9.png)

Double check with rmsd and Rg plots, more hydrophobic collapse geometries on the energy landscape were explored from the initial bioactive state through the addition of MC exchange argorithm among MD replicates   